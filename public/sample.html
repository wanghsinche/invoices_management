<!DOCTYPE>
<html>

<head>
    <title>
        test
    </title>
    <button type="submit" onclick="preAuthorize()">preAuthorize</button>
    <label><input type="input" id="detail" name="" value=""></label>
    <button type="submit" onclick="getinfo()"> get info</button>
    <script src="https://cdn.bootcss.com/axios/0.16.2/axios.min.js"></script>
    <script src="https://cdn.bootcss.com/crypto-js/3.1.9/crypto-js.min.js"></script>
</head>

<body>
    <script>
        function getToken(userid, usrpswd, reqnonce, reqtimes, reqstamp) {
            let hash = CryptoJS.HmacSHA256(userid, usrpswd, reqnonce, reqtimes, reqstamp);
            let hashInBase64 = CryptoJS.enc.Base64.stringify(hash);
            console.log(hashInBase64);
            return hashInBase64;
        }

        function buildAuthContent(userid, nonce, times, stamp, token) {
            var str = ['userid=' + userid, 'nonce=' + nonce, 'times=' + times, 'stamp=' + stamp, 'token=' + token].join(';');
            return str;
        }

        var usrpswd = '981755';
        var userid = '1', times = 0, stamp, nonce= '6812'; 

        

        function preAuthorize(){
            axios({
                method: 'get',
                url: 'http://localhost:8000/query/login',
            }).then(function(response){
                nonce = response.data.data.nonce;
                console.log(nonce);
                
            });           
        }


        function getinfo(){
            stamp = Date.now().toString();
            var token = getToken(userid, usrpswd, nonce, times.toString(), stamp);
            axios({
                method: 'get',
                url: 'http://localhost:8000/query/detail/4',
                headers: {
                    'Authorization':buildAuthContent(userid,nonce,times,stamp,token)
                }
            })
            .then(function (response) {
                    times++;
                    console.log(response);
            });
        }
    </script>
</body>

</html>